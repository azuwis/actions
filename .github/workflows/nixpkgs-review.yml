name: Nixpkgs Review
permissions: {}
on:
  workflow_dispatch:
    inputs:
      debug:
        description: Enable debug
        type: boolean
        required: false
        default: false
      os:
        description: OS
        required: true
        type: choice
        options: 
          - linux
          - darwin
          - aarch64-darwin
          - x86_64-darwin
          - all
        default: all
      pr:
        description: Pull request to review
        type: string
        required: true
run-name: Nixpkgs Review ${{ inputs.pr }}
jobs:
  nixpkgs-review:
    strategy:
      fail-fast: false
      matrix:
        os: >-
          ${{ fromJSON(
            inputs.os == 'linux' && '["ubuntu-latest"]' || (
            inputs.os == 'darwin' && '["macos-latest", "macos-13"]' || (
            inputs.os == 'aarch64-darwin' && '["macos-latest"]' || (
            inputs.os == 'x86_64-darwin' && '["macos-13"]' || (
            '["ubuntu-latest", "macos-latest", "macos-13"]'
          ))))) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./nix
        with:
          key: nixpkgs-review
          debug: ${{ github.event_name == 'workflow_dispatch' && inputs.debug }}
      - name: Install tools
        run: |
          nix-env -f '<nixpkgs>' -iA cloudflared tmux
          nix build --no-link --profile ~/.local/state/nix/profiles/shell github:Mic92/nixpkgs-review/pull/426/head
      - uses: ./nix/post
      - uses: actions/checkout@v4
        with:
          repository: NixOS/nixpkgs
          path: nixpkgs
      - name: Run nixpkgs-review pr ${{ inputs.pr }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST: ${{ inputs.pr }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          cd nixpkgs
          nix shell ~/.local/state/nix/profiles/shell --command nixpkgs-review pr --no-shell --print-result "$PULL_REQUEST"
      - uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.os }}
          path: ~/.cache/nixpkgs-review/
  summary:
    needs: nixpkgs-review
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
    - name: Summary
      run: |
        generate_summary() {
          reports=(report-ubuntu-*/*/report.md)
          reports+=(report-macos-*/*/report.md)
          cat "${reports[0]}"
          sed -s -n -e '/---/,$p' -e '1i\
        ' "${reports[@]:1}" 2>/dev/null
        }

        summary=$(generate_summary)

        cat >> $GITHUB_STEP_SUMMARY <<EOF
        $summary

        ---
        \`\`\`
        $summary
        \`\`\`
        EOF
