name: Nixpkgs Review
permissions: {}
on:
  workflow_dispatch:
    inputs:
      debug:
        description: Enable debug
        type: boolean
        required: false
        default: false
      os:
        description: OS
        required: true
        type: choice
        options: 
          - '["ubuntu-latest"]'
          - '["macos-latest"]'
          - '["macos-13"]'
          - '["macos-latest", "macos-13"]'
          - '["ubuntu-latest", "macos-latest", "macos-13"]'
      pr:
        description: Pull request to review
        type: string
        required: true
run-name: Nixpkgs Review ${{ inputs.pr }}
jobs:
  nixpkgs-review:
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJSON(inputs.os) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./nix
        with:
          key: nixpkgs-review
          debug: ${{ github.event_name == 'workflow_dispatch' && inputs.debug }}
      - name: Install tools
        run: |
          nix-env -f '<nixpkgs>' -iA cloudflared tmux
          nix build --no-link --profile ~/.local/state/nix/profiles/shell github:Mic92/nixpkgs-review/pull/426/head
      - uses: ./nix/post
      - uses: actions/checkout@v4
        with:
          repository: NixOS/nixpkgs
          path: nixpkgs
      - name: Run nixpkgs-review pr ${{ inputs.pr }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST: ${{ inputs.pr }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          cd nixpkgs
          nix shell ~/.local/state/nix/profiles/shell --command nixpkgs-review pr --print-result "$PULL_REQUEST"
          cat ~/.cache/nixpkgs-review/*/report.md >> $GITHUB_STEP_SUMMARY
          echo -e '\n---\n\n```' >> $GITHUB_STEP_SUMMARY
          cat ~/.cache/nixpkgs-review/*/report.md >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
